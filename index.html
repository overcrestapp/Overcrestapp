<!doctype html>
<html lang="sv">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Digital Fordonswhiteboard</title>
    <meta http-equiv="Content-Security-Policy"
      content="default-src 'self' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; script-src 'self' 'unsafe-inline'; img-src 'self' data:;">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-950 text-slate-100 min-h-screen">
    <div class="max-w-5xl mx-auto p-6 relative">
      <!-- Rubrik -->
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold tracking-tight">Digital Fordonswhiteboard</h1>
        <div id="measure" class="flex flex-col gap-2 items-end"></div>
      </div>

      <!-- Fordonsrader -->
      <div id="vehicles" class="space-y-3">
        <!-- Skapas med JS -->
      </div>
    </div>

    <script>
      const LS_KEY = "fordonswhiteboard_v2";
      const data = loadLS() || { vehicles: {}, measures: {} };
      const startNr = 67, rows = 25;

      // ========== Hjälp =============
      function loadLS() {
        try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null }
      }
      function saveLS() {
        try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch {}
      }
      function nowTime() {
        const d = new Date();
        const dt = d.toLocaleDateString('sv-SE');
        const tm = d.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        return `${dt} ${tm}`;
      }

      // ========== Fordonsrader ==========
      const vehiclesEl = document.getElementById("vehicles");

      for (let i = 0; i < rows; i++) {
        const nr = startNr + i;
        const wrap = document.createElement("div");
        wrap.className =
          "flex items-center justify-between rounded-2xl bg-slate-900 border border-slate-800 shadow-inner px-4 py-3 transition-all duration-200";

        // Nummer
        const label = document.createElement("div");
        label.className =
          "text-xl font-semibold w-14 text-center bg-slate-800/60 rounded-xl py-2 select-none";
        label.textContent = nr;

        // Skrivruta
        const input = document.createElement("textarea");
        input.rows = 1;
        input.placeholder = "Anteckning / status för fordonet...";
        input.className =
          "flex-1 ml-3 mr-3 bg-slate-800/40 rounded-xl px-4 py-2 resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 transition text-slate-100 placeholder-slate-400";
        input.value = data.vehicles[nr]?.text || "";
        input.addEventListener("input", () => {
          input.style.height = "auto";
          input.style.height = Math.min(120, input.scrollHeight) + "px";
          data.vehicles[nr] = data.vehicles[nr] || {};
          data.vehicles[nr].text = input.value;
          saveLS();
        });

        // Körförbud-knapp
        const btn = document.createElement("button");
        btn.textContent = "Körförbud";
        btn.className =
          "px-4 py-2 text-sm font-semibold rounded-xl bg-red-600 hover:bg-red-500 shadow transition";
        const banned = !!data.vehicles[nr]?.ban;
        if (banned) markBan(true);
        btn.addEventListener("click", () => {
          const state = !!data.vehicles[nr]?.ban;
          markBan(!state);
          data.vehicles[nr] = data.vehicles[nr] || {};
          data.vehicles[nr].ban = !state;
          saveLS();
        });

        function markBan(active) {
          if (active) {
            wrap.classList.add("bg-red-900/80", "border-red-700");
            wrap.classList.remove("bg-slate-900", "border-slate-800");
            input.classList.add("bg-red-800/40", "text-red-100", "placeholder-red-200");
          } else {
            wrap.classList.remove("bg-red-900/80", "border-red-700");
            wrap.classList.add("bg-slate-900", "border-slate-800");
            input.classList.remove("bg-red-800/40", "text-red-100", "placeholder-red-200");
          }
        }

        wrap.append(label, input, btn);
        vehiclesEl.appendChild(wrap);
      }

      // ========== Mätning F1–F3 ==========
      const measureEl = document.getElementById("measure");
      ["F1", "F2", "F3"].forEach((tag) => {
        const box = document.createElement("div");
        box.className =
          "flex items-center gap-2 bg-slate-900 border border-slate-800 px-3 py-2 rounded-xl shadow w-56 justify-between";

        const label = document.createElement("div");
        label.className = "font-semibold text-slate-200";
        label.textContent = tag;

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "Mätvärde...";
        input.className =
          "flex-1 bg-slate-800/40 rounded-lg px-2 py-1 text-right outline-none placeholder-slate-500";
        input.value = data.measures[tag]?.val || "";

        const time = document.createElement("div");
        time.className = "text-[0.7rem] text-slate-400 ml-1";
        time.textContent = data.measures[tag]?.time || "";

        input.addEventListener("input", () => {
          const t = nowTime();
          data.measures[tag] = { val: input.value, time: t };
          time.textContent = input.value ? t : "";
          saveLS();
        });

        box.append(label, input);
        box.appendChild(time);
        measureEl.appendChild(box);
      });
    </script>
  </body>
</html>
